version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: aiser-postgres-dev
    env_file: .env  # Moved here
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-aiser_world}
      POSTGRES_USER: ${POSTGRES_USER:-aiser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-aiser_password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-aiser} -d ${POSTGRES_DB:-aiser_world}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: aiser-redis-dev
    env_file: .env  # Moved here
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClickHouse Data Warehouse
  clickhouse:
    image: clickhouse/clickhouse-server:24.8-alpine
    container_name: aiser-clickhouse-dev
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-aiser_warehouse}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-aiser}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-aiser_warehouse_password}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_dev_data:/var/lib/clickhouse
      - ./scripts/clickhouse-init:/docker-entrypoint-initdb.d
      - ./clickhouse-config/users.xml:/etc/clickhouse-server/users.d/custom-users.xml:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        /entrypoint.sh &
        sleep 5
        /docker-entrypoint-initdb.d/02-insert-data.sh || true
        wait
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8123/ping"]
      interval: 15s
      timeout: 10s
      retries: 10
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - default

  # Chat2Chart Server
  chat2chart-server:
    build:
      context: ./packages/chat2chart/server
      dockerfile: Dockerfile.dev
    container_name: aiser-chat2chart-dev
    env_file:
      - .env
    ports:
      - "8000:8000"
      # - "5678:5678"  # Debugpy port for remote debugging
    volumes:
      - ./packages/chat2chart/server:/app
      - chat2chart_poetry_cache:/root/.cache/poetry
    environment:
      - POSTGRES_SERVER=postgres
      - POSTGRES_DB=${POSTGRES_DB:-aiser_world} # Unified database
      - POSTGRES_USER=${POSTGRES_USER:-aiser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-aiser_password}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-aiser}:${POSTGRES_PASSWORD:-aiser_password}@postgres:${POSTGRES_PORT:-5432}/aiser_world
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-True}
      - ALLOW_UNVERIFIED_JWT_IN_DEV=${ALLOW_UNVERIFIED_JWT_IN_DEV:-true}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME:-gpt-5-mini}
      - AZURE_OPENAI_GPT41_API_KEY=${AZURE_OPENAI_GPT41_API_KEY}
      - AZURE_OPENAI_GPT41_ENDPOINT=${AZURE_OPENAI_GPT41_ENDPOINT}
      - AZURE_OPENAI_GPT41_API_VERSION=${AZURE_OPENAI_GPT41_API_VERSION}
      - AZURE_OPENAI_GPT41_DEPLOYMENT_NAME=${AZURE_OPENAI_GPT41_DEPLOYMENT_NAME:-gpt-4.1-mini}
      - AZURE_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_API_BASE=${AZURE_OPENAI_ENDPOINT}
      - AZURE_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-aiser}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-aiser_warehouse_password}
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-aiser_warehouse}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-eswk8A65hCHznUBX4uiXHJihI8CldBQ9noFDVOjLFj0=}
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1 # Ensure Python output is unbuffered
    networks:
      - default
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Overwrite the default command with our entrypoint script for migrations
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -ex;
        echo "Waiting for PostgreSQL to be ready...";
        until nc -z postgres 5432; do
            echo "PostgreSQL is unavailable - sleeping";
            sleep 2;
        done;
        
        echo "PostgreSQL is up - running migrations...";
        poetry run alembic -c alembic.ini upgrade head || echo "Migration failed or already applied";
        echo "Starting chat2chart-server...";
        poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000;
        # Uncomment this to use debugpy
        # poetry run python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m uvicorn app.main:app --host 0.0.0.0 --port 8000;
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  chat2chart-client:
    build:
      context: ./packages/chat2chart/client
      dockerfile: Dockerfile.dev
    container_name: aiser-client-dev
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://chat2chart-server:8000
      - NEXT_PUBLIC_BACKEND_URL=http://chat2chart-server:8000
      - NODE_ENV=development
      - API_TARGET=http://chat2chart-server:8000
      - NEXT_PUBLIC_SUPABASE_URL=https://hzlprtotvfdnbirmvohw.supabase.co
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bHBydG90dmZkbmJpcm12b2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTg0MzAsImV4cCI6MjA4MDM5NDQzMH0.VZYDAeaTtoEPk7KEBNAxdxSE57Utgowprto3iQNaryM
    volumes:
      - ./packages/chat2chart/client:/app
      - client_node_modules:/app/node_modules # Use named volume for node_modules to avoid conflicts
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        echo "Starting client container..."
        echo "Waiting for volume mount to be ready..."
        # Wait for package.json to appear (volume mount might take a moment)
        # The bind mount should mount the source directory, but node_modules volume might interfere
        max_attempts=10
        attempt=1
        while [ "$attempt" -le "$max_attempts" ]; do
          if [ -f /app/package.json ]; then
            echo "✅ package.json found!"
            break
          fi
          echo "Waiting for package.json... (attempt $attempt/$max_attempts)"
          sleep 2
          attempt=$((attempt + 1))
        done
        if [ ! -f /app/package.json ]; then
          echo "❌ ERROR: package.json not found in /app after waiting"
          echo "Listing /app contents:"
          ls -la /app/ || true
          echo "Checking if /app exists:"
          test -d /app && echo "/app directory exists" || echo "/app directory does not exist"
          echo "Checking volume mounts:"
          mount | grep /app || true
          echo "Trying to access package.json directly:"
          cat /app/package.json 2>&1 || echo "Cannot read package.json"
          exit 1
        fi
        echo "package.json found. Waiting for dependencies..."
        until nc -z chat2chart-server 8000; do
          echo "Waiting for chat2chart-server..."
          sleep 5
        done
        echo "Dependencies ready. Installing npm packages..."
        cd /app
        npm install
        echo "Starting Next.js dev server..."
        npm run dev
    networks:
      - default
    depends_on:
      chat2chart-server:
        condition: service_started
    restart: unless-stopped

volumes:
  postgres_dev_data:
  redis_dev_data:
  clickhouse_dev_data:
  chat2chart_poetry_cache:
  aiser-world_chat2chart_poetry_cache:
  client_node_modules:

networks:
  default:
    name: aiser-dev-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1