# Alembic Migrations - Models as Source of Truth

## Philosophy

**SQLAlchemy models in `app/db/models.py` are the SOURCE OF TRUTH for database schema.**

All database schema changes must follow this workflow:
1. **Edit models first** - Make changes to SQLAlchemy models in `app/db/models.py`
2. **Generate migration** - Use Alembic autogenerate to create migration from model changes
3. **Review migration** - Always review the generated migration file before applying
4. **Apply migration** - Run the migration to update the database

**Never edit the database schema directly.** All changes must go through this workflow.

## Standard Workflow

### 1. Edit Models

Make your schema changes in `app/db/models.py`:

```python
# Example: Adding a new column
class Conversation(BaseModel):
    __tablename__ = "conversation"
    # ... existing columns ...
    new_field = Column(String(100), nullable=True)  # Add new column
```

### 2. Generate Migration

Use Alembic autogenerate to create a migration from your model changes:

```bash
# From the server directory
cd packages/chat2chart/server

# Generate migration
poetry run alembic -c alembic.ini revision --autogenerate -m "Add new_field to conversation"

# Or if running in Docker container
poetry run alembic -c alembic.ini revision --autogenerate -m "Add new_field to conversation"
```

This will create a new migration file in `alembic/versions/` with a timestamp and description.

### 3. Review Generated Migration

**Always review the generated migration file before applying it!**

Open the generated file in `alembic/versions/` and verify:
- The changes match what you intended
- No unexpected columns are being added/removed
- Data migrations (if needed) are correct
- Indexes and constraints are properly handled

Example migration file:
```python
def upgrade():
    op.add_column('conversation', sa.Column('new_field', sa.String(length=100), nullable=True))

def downgrade():
    op.drop_column('conversation', 'new_field')
```

### 4. Apply Migration

Apply the migration to update the database:

```bash
# Apply all pending migrations
poetry run alembic -c alembic.ini upgrade head

# Or apply one migration at a time
poetry run alembic -c alembic.ini upgrade +1
```

## Common Commands

### Generate Migration from Model Changes

```bash
poetry run alembic -c alembic.ini revision --autogenerate -m "description of changes"
```

### Apply Migrations

```bash
# Apply all pending migrations
poetry run alembic -c alembic.ini upgrade head

# Apply next migration
poetry run alembic -c alembic.ini upgrade +1

# Apply up to specific revision
poetry run alembic -c alembic.ini upgrade <revision_id>
```

### Rollback Migrations

```bash
# Rollback last migration
poetry run alembic -c alembic.ini downgrade -1

# Rollback to specific revision
poetry run alembic -c alembic.ini downgrade <revision_id>

# Rollback all migrations
poetry run alembic -c alembic.ini downgrade base
```

### Check Migration Status

```bash
# Show current revision
poetry run alembic -c alembic.ini current

# Show migration history
poetry run alembic -c alembic.ini history

# Show pending migrations
poetry run alembic -c alembic.ini heads
```

### Create Empty Migration (Manual)

For complex migrations that autogenerate can't handle:

```bash
poetry run alembic -c alembic.ini revision -m "description"
```

Then manually edit the generated file to add your migration logic.

## Best Practices

### 1. Always Review Autogenerated Migrations

Alembic autogenerate is powerful but not perfect. Always review generated migrations to ensure:
- Column types are correct
- Indexes are properly created/dropped
- Foreign keys are handled correctly
- Default values are set appropriately
- Data migrations (if needed) are included

### 2. Test Migrations on Development Database First

Before applying migrations to production:
1. Test on a development database
2. Verify the migration applies successfully
3. Verify the rollback works correctly
4. Check that application code still works with new schema

### 3. Never Edit Database Schema Directly

**All schema changes must go through migrations:**
- ❌ Don't run `ALTER TABLE` directly in database
- ❌ Don't use `Base.metadata.create_all()` in production
- ✅ Always edit models first, then generate migrations
- ✅ Always use `alembic upgrade head` to apply changes

### 4. Keep Migrations Small and Focused

Each migration should represent a single logical change:
- ✅ Good: "Add email column to user table"
- ❌ Bad: "Add email, phone, address, and 10 other columns"

### 5. Write Reversible Migrations

Always ensure `downgrade()` properly reverses `upgrade()`:
- If you add a column, drop it in downgrade
- If you change a type, change it back in downgrade
- If you add an index, drop it in downgrade

### 6. Use Descriptive Migration Messages

Write clear, descriptive messages:
- ✅ Good: "Add user_id index to conversation table"
- ❌ Bad: "Update schema"

## Troubleshooting

### Autogenerate Misses Changes

If autogenerate doesn't detect your model changes:

1. **Check that models are imported in `alembic/env.py`**
   ```python
   from app.db.models import Conversation, Message, DataSource, FileStorage
   ```

2. **Verify `target_metadata = Base.metadata` is set in `alembic/env.py`**

3. **Check for naming mismatches** between model `__tablename__` and actual table names

4. **Create manual migration** if autogenerate can't detect the change

### Complex Migrations

For complex migrations (data transformations, renaming columns, etc.):

1. Generate empty migration: `alembic revision -m "description"`
2. Manually write `upgrade()` and `downgrade()` functions
3. Use `op.execute()` for raw SQL if needed:
   ```python
   def upgrade():
       op.execute("UPDATE table SET column = 'value' WHERE condition")
   ```

### Verify Models Match Database

Use the verification script to check if models match the database:

```bash
python scripts/verify-schema.py
```

If discrepancies are found:
1. Update models in `app/db/models.py` to match database (if database is correct)
2. Or generate a migration to update database to match models (if models are correct)

### Migration Conflicts

If you have migration conflicts (multiple heads):

```bash
# Show all heads
poetry run alembic -c alembic.ini heads

# Merge heads (creates a merge migration)
poetry run alembic -c alembic.ini merge -m "merge description" <head1> <head2>
```

## Docker/Development Environment

In the development environment (docker-compose), migrations run automatically:

1. When `chat2chart-server` container starts
2. Before the server starts
3. Using: `poetry run alembic -c alembic.ini upgrade head`

See `docker-compose.dev.yml` entrypoint for details.

## File Structure

```
server/
├── alembic/
│   ├── versions/          # Migration files (auto-generated)
│   ├── env.py            # Alembic environment config
│   └── README.md         # This file
├── alembic.ini           # Alembic configuration
└── app/
    └── db/
        ├── base.py       # Base and BaseModel
        ├── models.py     # SOURCE OF TRUTH - All models here
        └── session.py    # Database session management
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

