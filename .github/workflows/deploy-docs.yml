name: Deploy Documentation to GitHub Pages

# Only trigger on docs changes to avoid unnecessary runs
on:
  push:
    branches: [ main ]
    paths:
      - 'packages/docs/**'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:  # Allow manual trigger

# Add permissions for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Docusaurus 3.1.1 requires Node.js >= 20.0
          # No cache since package-lock.json doesn't exist in docs
          
      - name: Install dependencies
        run: npm install
        # Install from root to properly resolve workspace dependencies
        
      - name: Build documentation
        working-directory: packages/docs
        env:
          NODE_ENV: production
        run: npm run build
        # Build from docs directory after root dependencies are installed
        
      - name: Verify build output
        run: |
          echo "=== Build Verification ==="
          echo "Checking build directory contents:"
          ls -la packages/docs/build/ | head -20
          echo ""
          echo "Checking for index.html:"
          if [ -f packages/docs/build/index.html ]; then
            echo "‚úÖ index.html exists"
            echo "File size: $(wc -c < packages/docs/build/index.html) bytes"
          else
            echo "‚ùå index.html missing"
            exit 1
          fi
          echo ""
          echo "Checking for CNAME:"
          if [ -f packages/docs/build/CNAME ]; then
            echo "‚úÖ CNAME exists: $(cat packages/docs/build/CNAME)"
            if grep -q "docs.aicser.com" packages/docs/build/CNAME; then
              echo "‚úÖ CNAME contains correct domain"
            else
              echo "‚ùå CNAME has wrong domain"
              exit 1
            fi
          else
            echo "‚ùå CNAME missing - creating it"
            echo "docs.aicser.com" > packages/docs/build/CNAME
          fi
          echo ""
          echo "Checking for .nojekyll:"
          if [ -f packages/docs/build/.nojekyll ]; then
            echo "‚úÖ .nojekyll exists"
          else
            echo "‚ö†Ô∏è .nojekyll missing - creating it"
            touch packages/docs/build/.nojekyll
          fi
          echo ""
          echo "Build verification complete ‚úÖ"
          
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages/docs/build
          # Deploy to root for custom domain (baseUrl: '/')
          # No destination_dir means deploy to root of gh-pages branch
          cname: docs.aicser.com
          force_orphan: true
          # Ensure .nojekyll is created (for GitHub Pages)
          enable_jekyll: false
          # User information for commit
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'docs: deploy documentation to GitHub Pages [skip ci]'
          # Full history for better debugging
          full_history: false
        continue-on-error: false
          
      - name: Verify gh-pages branch after deployment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "=== Verifying gh-pages Branch After Deployment ==="
          echo "Waiting 5 seconds for GitHub to process the push..."
          sleep 5
          echo ""
          echo "Fetching gh-pages branch..."
          git fetch origin gh-pages:gh-pages 2>&1 || echo "‚ö†Ô∏è Could not fetch gh-pages (may not exist yet)"
          echo ""
          echo "Checking if gh-pages branch exists:"
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            echo "‚úÖ gh-pages branch exists"
            echo ""
            echo "Checking branch contents:"
            git ls-tree -r --name-only origin/gh-pages | head -20
            echo ""
            echo "Checking for critical files:"
            if git cat-file -e origin/gh-pages:index.html 2>/dev/null; then
              echo "‚úÖ index.html exists in gh-pages"
            else
              echo "‚ùå index.html NOT found in gh-pages branch"
            fi
            if git cat-file -e origin/gh-pages:CNAME 2>/dev/null; then
              echo "‚úÖ CNAME exists: $(git cat-file blob origin/gh-pages:CNAME)"
            else
              echo "‚ùå CNAME NOT found in gh-pages branch"
            fi
            if git cat-file -e origin/gh-pages:.nojekyll 2>/dev/null; then
              echo "‚úÖ .nojekyll exists"
            else
              echo "‚ö†Ô∏è .nojekyll NOT found (may cause issues)"
            fi
          else
            echo "‚ùå gh-pages branch does NOT exist!"
            echo "This means the deployment action did not create the branch."
            echo "Check the 'Deploy to GitHub Pages' step for errors."
          fi
          
      - name: Critical diagnosis - 404 on GitHub Pages URL
        if: github.ref == 'refs/heads/main'
        run: |
          echo ""
          echo "=== üö® CRITICAL: 404 on GitHub Pages URL ==="
          echo ""
          echo "If https://aiser-platform.github.io/aiser-world/ returns 404:"
          echo ""
          echo "1. üî¥ CHECK: Does gh-pages branch exist?"
          echo "   https://github.com/aiser-platform/aiser-world/tree/gh-pages"
          echo "   If branch doesn't exist, deployment failed"
          echo ""
          echo "2. üî¥ CHECK: Are files in gh-pages branch?"
          echo "   Should see: index.html, CNAME, .nojekyll, assets/"
          echo "   If files are missing, check 'Deploy to GitHub Pages' step logs"
          echo ""
          echo "3. üî¥ CHECK: Is GitHub Pages enabled for organization?"
          echo "   Organization Settings ‚Üí Pages"
          echo "   For organization repos, Pages must be enabled at org level"
          echo ""
          echo "4. üî¥ CHECK: Repository Pages settings"
          echo "   https://github.com/aiser-platform/aiser-world/settings/pages"
          echo "   Source MUST be: 'GitHub Actions'"
          echo "   If 'None' or disabled, enable it"
          echo ""
          echo "5. üî¥ CHECK: Organization Pages URL format"
          echo "   For organization repos, URL is:"
          echo "   https://ORGANIZATION.github.io/REPOSITORY-NAME/"
          echo "   NOT: https://ORGANIZATION.github.io/"
          echo ""
          echo "6. ‚ö†Ô∏è CHECK: Deployment action permissions"
          echo "   Verify GITHUB_TOKEN has 'pages: write' permission"
          echo "   Check workflow permissions in repository settings"
          echo ""
          echo "7. ‚ö†Ô∏è CHECK: Workflow logs for 'Deploy to GitHub Pages' step"
          echo "   Look for any errors or warnings"
          echo "   Check if action actually pushed to gh-pages branch"
          echo ""
          echo "=== Next Steps ==="
          echo "1. Verify gh-pages branch exists and has files"
          echo "2. Check organization Pages settings"
          echo "3. Verify repository Pages is enabled"
          echo "4. Check workflow permissions"
          echo "5. Review deployment step logs for errors"
          
      - name: Deploy to GitHub Pages (PR Preview)
        if: github.event_name == 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: packages/docs/build
          destination_dir: preview/${{ github.event_number }}
